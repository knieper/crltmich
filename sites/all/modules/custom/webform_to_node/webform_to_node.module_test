<?php
// $Id: webform_to_node.module

function webform_to_node_form_alter(&$form, $form_state, $form_id) {
  switch ($form_id) {
    case 'webform_client_form_3' :
    array_push($form['#submit'], 'webform_to_node_create_node');
    break;
  }
}

function webform_to_node_create_node(&$form, &$form_state, $form_id) {
  // Load all of the data submitted via the webform into a keyed array ($data)
  $data = array();
  foreach ($form_state['values']['submitted'] as $key => $value) {
    $data[$key] = $value;
    //drupal_set_message("key $key value $value", $type = 'status'); 
  }

  // The node_save() function (called later in this function) call
  // node_access_check, which means that anonymous calls to this function will
  // not be successful. Top get around this, we load the CRLT _webform_node user
  // while executing this function, then restore the user back to the original 
  // state at the end of the function.
  
  global $user;
  $original_user = $user;
  $user = user_load(59908);

  // Initialize the new node with default stuff
  $node = new stdClass();
  $node->type = 'consultation';
  $node->created = time();
  $node->changed = $node->created;
  $node->status = 1;
  $node->promote = 0;
  $node->sticky = 0;
  $node->format = 1;
  $node->uid = $user->uid;
  $node->field_status[0]['value'] = 'New Request';
  $node->field_num_contacts[0]['value'] =  1;
  $node->field_annual_report_ind[0]['value'] =  'No';
  $node->field_client[0]['uid'] =  $original_user->uid;
  if ($data[3] == 'GSI') 
     { $node->field_service_provider[0]['value'] = 'gtc';}
// drupal_set_message("formid = $form['form_id']", $type = 'status'); 
  //form specific processing
  //switch ($form_id) {
    //case 'webform_client_form_3' :
  	$webform_nid = 3;
  	$node->title = 'MSF';
  	$node->body = $data[9];
  	$node->field_consult_type[0]['value'] =  'Midterm Student Feedback';
  	$node->field_client_department[0]['value'] =  $data[22];
  	$node->field_gtc_points[0]['value'] = 2;
  	$node->field_course_number[0]['value'] = $data[2];
  	$node->field_msf_preferred_dates[0]['value'] =  "class meets: $data[6]; preferred dates: $data[7]";
  	$node->field_num_students[0]['value'] =  $data[5];
    	//break;
  //}

  $query = ("SELECT sid FROM {webform_submitted_data} WHERE nid=%d ORDER BY sid DESC Limit 1");
  $res = db_query($query, $webform_nid);
  $row = db_fetch_object($res);
  $sid = $row->sid;
  $node->field_req_url[0]['title'] =  'Link to Request';
  $node->field_req_url[0]['url'] =  "https://www.crlt.umich.edu/node/$webform_nid/submission/$sid";

  //Save the node
  node_save($node);

  //Set the user state back to the original
  $user = $original_user;

}

function msf_webform_to_node_fields(&$node, &$data) {
}
function msf_webform_to_node_create_node(&$form, &$form_state) {
  // Load all of the data submitted via the webform into a keyed array ($data)
$webform_nid = 3;
  $data = array();
  foreach ($form_state['values']['submitted'] as $key => $value) {
    $data[$key] = $value;
  }

 $query = ("SELECT sid FROM {webform_submitted_data} WHERE nid=%d ORDER BY sid DESC Limit 1");
  $res = db_query($query, $webform_nid);
  $row = db_fetch_object($res);
  $sid = $row->sid;


  // The node_save() function (called later in this function) call
  // node_access_check, which means that anonymous calls to this function will
  // not be successful. Top get around this, we load the CRLT _webform_node user
  // while executing this function, then restore the user back to the original 
  // state at the end of the function.
  
  global $user;
//drupal_set_message("user $user->uid", $type = 'status');
  $original_user = $user;
  $user = user_load(59908);

  // Initialize the new node with default stuff
  $node = new stdClass();
  $node->type = 'consultation';
  $node->created = time();
  $node->changed = $node->created;
  $node->status = 1;
  $node->promote = 0;
  $node->sticky = 0;
  $node->format = 1;
  $node->uid = $user->uid;
  $node->title = 'MSF';
  $node->body = $data[9];
  $node->field_status[0]['value'] = 'New Request';
  $node->field_gtc_points[0]['value'] = 2;
  $node->field_course_number[0]['value'] = $data[2];
  $node->field_msf_preferred_dates[0]['value'] =  "class meets: $data[6]; preferred dates: $data[7]";
  $node->field_num_students[0]['value'] =  $data[5];
  $node->field_consult_type[0]['value'] =  'Midterm Student Feedback';
  $node->field_client_department[0]['value'] =  $data[22];
  $node->field_num_contacts[0]['value'] =  1;
  $node->field_annual_report_ind[0]['value'] =  'No';
if ($data[3] == 'GSI') 
     { $node->field_service_provider[0]['value'] = 'gtc';}

$node->field_req_url[0]['url'] =  "https://www.crlt.umich.edu/node/3/submission/$sid";
  $node->field_req_url[0]['title'] =  'Link to Request';
  //FIX the SUBMISSION ID to the correct variable some day soon!
  $node->field_client[0]['uid'] =  $original_user->uid;
  
  //Save the node
  node_save($node);

  //Set the user state back to the original
  $user = $original_user;
}
